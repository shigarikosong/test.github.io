<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ã—ãŒã‚Šã“ã®ã†ãŸsã€‚ï½œå¸è³€ã‚Šã“éå…¬å¼ãƒ•ã‚¡ãƒ³ã‚µã‚¤ãƒˆ</title>
  <link rel="icon" type="image/svg+xml" href="/icon.svg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Cantarell", "Fira Sans", "Droid Sans", sans-serif;
    }
    .fade-in {
      animation: fadeIn 0.4s ease-out both;
    }
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

/* ãƒªã‚¹ãƒˆé …ç›®ã®ã‚¹ã‚¿ã‚¤ãƒ« */
#videoList div {
  border-radius: 8px;
}


.meta-row {
  display: flex;
  flex-wrap: wrap; /* å¿µã®ãŸã‚ */
  gap: 8px;
  margin-top: 2px;
  line-height: 1.4;
  white-space: nowrap; /* ã“ã‚Œã§1è¡Œã«æƒãˆã‚„ã™ããªã‚‹ */
}

.meta-label {
  font-weight: 600;
  margin-right: 2px;
  color: #374151; /* ãƒ€ãƒ¼ã‚¯ã‚°ãƒ¬ãƒ¼ */
}

.meta-value {
  margin-right: 16px;
}

.video-item-row {
  display: flex;
  flex-wrap: nowrap;
  gap: 0.5rem;
  align-items: center;
  overflow-x: auto;
  white-space: nowrap;
  min-width: 0
}

.video-title {
  flex: 3;
  min-width: 0;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  text-align: left;
  font-weight: 600;
  color: #1e40af;
}


.video-artist {
  flex: 2;
  min-width: 0;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  color: #374151;
}


.video-meta {
  display: flex;
  flex-wrap: nowrap;
  gap: 1rem;
  font-size: 0.875rem;
  color: #4b5563; /* text-gray-600 */
  overflow: hidden;
  white-space: nowrap;
}



#videoList a:hover {
  text-decoration: underline;  /* ãƒ›ãƒãƒ¼æ™‚ã«ä¸‹ç·šã‚’è¿½åŠ  */
}

    #videoList .playing {
  background-color: #fffbe6; /* æ·¡ã„é»„è‰²ã«å¤‰æ›´ */
  border-left: 4px solid #facc15; /* é»„è‰²ã®ãƒ©ã‚¤ãƒ³è¿½åŠ  */
}

    /* ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’å›ºå®š */
header {
  position: static; /* â† è¿½åŠ ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã«æˆ»ã™ï¼‰ */
  background-color: white;
}

/* ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³ã‚’å›ºå®š */
section {
  position: sticky;
  top: 0px; 
  z-index: 20;  /* ãƒ˜ãƒƒãƒ€ãƒ¼ã‚ˆã‚Šä¸‹ã«é…ç½® */
  background-color: white;
  padding-top: 10px;
  padding-bottom: 10px;
}

      /* å›ºå®šãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç”¨ã®CSS */
  #fixedPlayer {
    display: none; /* æœ€åˆã¯éè¡¨ç¤º */
    bottom: 0px;  /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®é«˜ã• + ä½™ç™½åˆ†ã ã‘ä¸Šã«é…ç½® */
  }

    #fixedPlayer .controls-wrapper {
  padding-bottom: 8px; /* â† å¿…è¦ã«å¿œã˜ã¦å¢—ã‚„ã—ã¦èª¿æ•´ */
}


#nowPlayingWrapper {
  background-color: #e0f2fe;
  box-shadow: 0 -2px 6px rgba(0, 0, 0, 0.1);
  height: auto; /* é«˜ã•ã‚’å›ºå®šå€¤ã‹ã‚‰è‡ªå‹•ã« */
  padding-top: 4px;
  padding-bottom: 8px; /* ãƒœã‚¿ãƒ³ã«ä½™è£•ã‚’æŒãŸã›ã‚‹ */
}
#videoList .playing {
  background-color: #fffbe6; /* ãƒã‚¤ãƒ©ã‚¤ãƒˆè‰² */
  border-left: 4px solid #facc15; /* ã‚¢ã‚¯ã‚»ãƒ³ãƒˆãƒ©ã‚¤ãƒ³ */
}

    /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é«˜ã•ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã§å¤‰æ›´ã™ã‚‹ãƒãƒ³ãƒ‰ãƒ« */
#playerResizeHandle {
  position: absolute;
  top: -10px;          /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ä¸Šã«å°‘ã—ã¯ã¿å‡ºã™ */
  left: 0;
  width: 100%;
  height: 12px;        /* ã¤ã‹ã¿ã‚„ã™ã„å¹… */
  cursor: ns-resize;
  z-index: 5;
  background: transparent;
  touch-action: none; 
}
    
#playerResizeHandle::after {
  content: "";
  position: absolute;
  left: 50%;
  top: 4px;
  transform: translateX(-50%);
  width: 56px;
  height: 4px;
  border-radius: 9999px;
  background: rgba(0,0,0,0.25);  /* ã¤ã¾ã¿ã®ç›®å°ï¼ˆå¥½ã¿ã§èª¿æ•´/å‰Šé™¤OKï¼‰ */
}


  </style>

  <script src="https://www.youtube.com/iframe_api"></script>
</head>
  
<body style="background-color: #FFE36C;" class="text-gray-800">
  <header class="relative border-b z-10 bg-white/90 backdrop-blur px-4 py-3 shadow-sm">
  <h1 class="text-left text-xl sm:text-2xl font-semibold text-gray-900 tracking-tight">
  ã—ãŒã‚Šã“ã®ã†ãŸã€‚<br class="sm:hidden"><span class="text-sm sm:text-base">ï½œå¸è³€ã‚Šã“éå…¬å¼ãƒ•ã‚¡ãƒ³ã‚µã‚¤ãƒˆ</span>
</h1>

  <div class="absolute right-4 top-1/2 -translate-y-1/2 flex space-x-4 items-center">
    <a href="https://www.youtube.com/@ShigaRiko" target="_blank" rel="noopener" aria-label="YouTube">
      <img src="./YT_icon.svg" alt="YouTube" class="w-8 h-8" />
    </a>
    <a href="https://www.tiktok.com/@riko14218" target="_blank" rel="noopener" aria-label="TikTok">
      <img src="./TT_icon.svg" alt="TikTok" class="w-8 h-8" />
    </a>
    <a href="https://x.com/Shigariko_" target="_blank" rel="noopener" aria-label="X">
      <img src="./X_icon.svg" alt="X" class="w-8 h-8" />
    </a>
  </div>
</header>

  <div class="max-w-4xl mx-auto px-4 mt-4 text-center text-sm text-gray-600">
  ã«ã˜ã•ã‚“ã˜æ‰€å± å¸è³€ã‚Šã“ã•ã‚“ã®æ­Œã£ã¦ã¿ãŸã‚„æ­Œæ ãªã©ã‚’ã¾ã¨ã‚ãŸéå…¬å¼ãƒ•ã‚¡ãƒ³ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã§ã™ã€‚<br>
  Youtube(æ­Œã£ã¦ã¿ãŸã€shortsã€æ­Œæ ) / tiktok ã‚’æ²è¼‰ã—ã¦ã„ã¾ã™ã€‚<br>
  tiktokã®ã¿ã€ä»•æ§˜ä¸Šyoutubeã«æ¯”ã¹ã‚‹ã¨å†ç”ŸéŸ³ãŒå¤§ãã„ç‚ºã€ã”æ³¨æ„ãã ã•ã„ã€‚<br>
</div>

  <section class="max-w-8xl mx-auto mt-6 mb-6 px-4">

<!-- ãƒ¢ãƒã‚¤ãƒ«ç”¨ï¼šçµã‚Šè¾¼ã¿ï¼‹ãƒ©ãƒ³ãƒ€ãƒ å†ç”Ÿã‚’æ¨ªä¸¦ã³ -->
<div class="flex sm:hidden items-center justify-center gap-2 mt-4 px-4">
  <button id="openFilterModal" class="bg-blue-500 text-white px-4 py-2 rounded-md w-full">
    ğŸ” çµã‚Šè¾¼ã¿
  </button>
  <button id="mobileRandomPlayButton" class="bg-green-500 text-white px-4 py-2 rounded-md w-full">
    ğŸ² ãƒ©ãƒ³ãƒ€ãƒ å†ç”Ÿ
  </button>
</div>

<div id="filters" class="grid md:grid-cols-4 gap-3">
  <!-- å…±é€š: filter-dropdown ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ -->
  <div class="relative filter-dropdown">
    <button type="button" class="filter-toggle w-full flex items-center justify-between px-3 py-2 border rounded bg-white"
            aria-expanded="false">
      <span class="text-sm font-medium">ã‚«ãƒ†ã‚´ãƒª</span>
      <span class="chevron transition-transform">â–¾</span>
    </button>
    <div class="filter-menu absolute left-0 mt-1 w-full bg-white border rounded shadow max-h-56 overflow-y-auto hidden z-30">
      <div class="space-y-1 p-2" data-group="category"></div>
    </div>
  </div>

  <div class="relative filter-dropdown">
    <button type="button" class="filter-toggle w-full flex items-center justify-between px-3 py-2 border rounded bg-white"
            aria-expanded="false">
      <span class="text-sm font-medium">å…¬é–‹æ—¥</span>
      <span class="chevron transition-transform">â–¾</span>
    </button>
    <div class="filter-menu absolute left-0 mt-1 w-full bg-white border rounded shadow max-h-56 overflow-y-auto hidden z-30">
      <div class="space-y-1 p-2" data-group="month"></div>
    </div>
  </div>

  <div class="relative filter-dropdown">
    <button type="button" class="filter-toggle w-full flex items-center justify-between px-3 py-2 border rounded bg-white"
            aria-expanded="false">
      <span class="text-sm font-medium">å‹•ç”»ç¨®åˆ¥</span>
      <span class="chevron transition-transform">â–¾</span>
    </button>
    <div class="filter-menu absolute left-0 mt-1 w-full bg-white border rounded shadow max-h-56 overflow-y-auto hidden z-30">
      <div class="space-y-1 p-2" data-group="videoType"></div>
    </div>
  </div>

  <div class="relative filter-dropdown">
    <button type="button" class="filter-toggle w-full flex items-center justify-between px-3 py-2 border rounded bg-white"
            aria-expanded="false">
      <span class="text-sm font-medium">æ‹…å½“åŒºåˆ†</span>
      <span class="chevron transition-transform">â–¾</span>
    </button>
    <div class="filter-menu absolute left-0 mt-1 w-full bg-white border rounded shadow max-h-56 overflow-y-auto hidden z-30">
      <div class="space-y-1 p-2" data-group="role"></div>
    </div>
  </div>
</div>
    
 <!-- ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ -->
<div class="mt-3 flex flex-wrap items-center gap-2">
  <!-- æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ï¼šåºƒãŒã‚‹ -->
  <input id="searchInput" type="text" placeholder="æ›²åãƒ»ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ"
    class="flex-1 min-w-[220px] rounded-md border border-gray-300 px-3 h-10 text-sm focus:ring-blue-300 transition">

  <!-- ä¸¦ã³é †ï¼šå›ºå®šå¹… -->
  <select id="sortOrder"
    class="w-40 rounded-md border border-gray-300 px-3 h-10 text-sm focus:ring-blue-300 transition">
    <option value="desc">æ–°ã—ã„é †</option>
    <option value="asc">å¤ã„é †</option>
    <option value="title">æ›²åé †</option>
    <option value="artist">ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆé †</option>
  </select>

  <!-- ãƒªã‚»ãƒƒãƒˆ -->
  <button id="resetFilters"
    class="rounded-md bg-blue-100 hover:bg-blue-200 text-blue-900 font-medium text-sm px-4 h-10 transition">
    ãƒªã‚»ãƒƒãƒˆ
  </button>

  <!-- ãƒ©ãƒ³ãƒ€ãƒ å†ç”Ÿ -->
  <button id="randomPlayButton"
    class="rounded-md bg-green-100 hover:bg-green-200 text-green-900 font-medium text-sm px-4 h-10 transition">
    ãƒ©ãƒ³ãƒ€ãƒ å†ç”Ÿ
  </button>
</div>

  <main id="videoList" class="max-w-4xl mx-auto px-4 py-8 divide-y divide-gray-200"> 
  </main>

  <footer class="text-center text-xs text-gray-500 mt-12 px-4 pb-64 space-y-2">
  <p>æœ¬ã‚µã‚¤ãƒˆã¯ãƒ•ã‚¡ãƒ³ã«ã‚ˆã‚‹éå…¬å¼ãƒšãƒ¼ã‚¸ã§ã™ã€‚</p>
  <p>ã“ã®ã‚µã‚¤ãƒˆã¯ <a href="https://pages.github.com/" class="underline" target="_blank" rel="noopener" >GitHub Pages</a> ã‚’åˆ©ç”¨ã—ã¦å…¬é–‹ã—ã¦ã„ã¾ã™ã€‚</p>
  <p>å‹•ç”»ã¯å„é…ä¿¡ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®åŸ‹ã‚è¾¼ã¿æ©Ÿèƒ½ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚</p>
    
 <p class="mt-6">åˆ¶ä½œã«ã‚ãŸã‚Šã€ä»¥ä¸‹ã®ã‚µã‚¤ãƒˆã‚’å‚è€ƒã«ã•ã›ã¦ã„ãŸã ãã¾ã—ãŸï¼ˆæ•¬ç§°ç•¥ãƒ»é †ä¸åŒï¼‰ï¼š</p>
<ul class="list-disc list-inside text-left mx-auto max-w-md text-gray-500">
  <li><a href="https://chimauta.pages.dev/" class="underline" target="_blank" rel="noopener" >ã¡ã¾ã†ãŸï½œç”ºç”°ã¡ã¾éå…¬å¼ãƒ•ã‚¡ãƒ³ã‚µã‚¤ãƒˆ</a></li>
  <li><a href="https://uta.inui-dondon-sukininaru.net/" class="underline" target="_blank" rel="noopener" >ã„ã¬ã„ã®ã†ãŸ | æˆŒäº¥ã¨ã“éå…¬å¼ãƒ•ã‚¡ãƒ³ã‚µã‚¤ãƒˆ</a></li>
</ul>

<p class="mt-6">æ­Œæ ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚„æ›²æƒ…å ±ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã§æ²è¼‰ã—ã¦ãã‚Œã¦ã„ã‚‹çš†ã•ã¾ã«æ„Ÿè¬ã€‚</p>

 <p>æœ€çµ‚æ›´æ–°æ—¥ï¼š2025/08/16</p>
</footer>
 
<!-- å†ç”Ÿä¸­ã®æ›²åã¨ãƒœã‚¿ãƒ³ã‚’ä¸€ã¤ã®ç®±ã«å…¥ã‚Œã‚‹ -->
<div id="nowPlayingWrapper" class="fixed bottom-0 left-0 w-full bg-blue-100 text-blue-900 z-30">
  <div id="nowPlaying" class="py-2 text-center font-medium">
    <span id="nowPlayingTitle">å†ç”Ÿä¸­</span>
  </div>
  
  <div id="playerControls" class="flex justify-center gap-2 py-2">
    <button id="prevVideoBtn" class="bg-gray-300 px-3 py-1 rounded">â—€ æˆ»ã‚‹</button>
    <button id="nextVideoBtn" class="bg-gray-300 px-3 py-1 rounded">â–¶ æ¬¡ã¸</button>
    <button id="randomFromFilteredBtn" class="bg-gray-300 px-3 py-1 rounded">ğŸ² ãƒ©ãƒ³ãƒ€ãƒ </button>
    <label id="autoNextUI" class="flex items-center gap-1 text-sm ml-3 select-none">
    <input type="checkbox" id="autoNextToggle" class="w-4 h-4">
    é€£ç¶šå†ç”Ÿ
  </label>
  </div>
</div>

<!-- å›ºå®šãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ -->
<div id="fixedPlayer" class="fixed bottom-0 left-0 w-full bg-white border-t shadow-lg z-20">
  <div class="max-w-4xl mx-auto p-4 relative">
    <button id="closePlayerBtn" class="absolute top-0 right-0 p-2 text-gray-700 hover:text-blue-600 font-bold">âœ–</button>
    <div id="playerResizeHandle" aria-label="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚µã‚¤ã‚ºèª¿æ•´ãƒãƒ³ãƒ‰ãƒ«"></div>

    <div id="playerFrameWrapper" class="bg-black rounded-xl overflow-hidden shadow-lg">
      <iframe id="playerIframe"
        class="w-full aspect-video"
        loading="lazy"
        src=""
        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
        allowfullscreen title="å‹•ç”»ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼"></iframe>
    </div>
  </div>
</div>
  
  <script>

    const fixedPlayerEl = document.getElementById('fixedPlayer');
    const playerIframe = document.getElementById('playerIframe');
    const playerFrameWrapper = document.getElementById('playerFrameWrapper');
    const resizeHandle = document.getElementById('playerResizeHandle');
    const closeBtn = document.getElementById('closePlayerBtn');
    const searchInput = document.getElementById('searchInput');
    const sortOrder = document.getElementById('sortOrder');
    const resetButton = document.getElementById('resetFilters');
    const videoList = document.getElementById('videoList');
    const SHOW_AUTONEXT_UI = false;

    const autoNextUI = document.getElementById('autoNextUI');
if (!SHOW_AUTONEXT_UI && autoNextUI) {
  autoNextUI.style.display = 'none';
}
    
    const sheetJsonUrl = 'https://opensheet.elk.sh/1sZGH3TGYdC5UShrIEFEe2T8-axXEFet6qsxbqCoHX5o/%E3%82%B7%E3%83%BC%E3%83%881';
    let allVideos = [];
    let currentFilteredVideos = [];
    let nowPlayingKey = null;

    const AUTO_NEXT_KEY = 'autoNextEnabled';
    function isAutoNextEnabled() {
      return localStorage.getItem(AUTO_NEXT_KEY) === '1';
    }
    function setAutoNextEnabled(on) {
      localStorage.setItem(AUTO_NEXT_KEY, on ? '1' : '0');
    }

    let ytPlayer = null;
let ytApiReady = false;

// YouTube IFrame API ã®æº–å‚™å®Œäº†ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
window.onYouTubeIframeAPIReady = () => {
  ytApiReady = true;
  tryInitYtPlayer();
};

// æ—¢å­˜ã® iframe(id="playerIframe") ã‚’ YT.Player åŒ–
function tryInitYtPlayer() {
  if (!ytApiReady) return;
  if (ytPlayer) return;
  const iframeEl = document.getElementById('playerIframe');
  if (!iframeEl) return;

  ytPlayer = new YT.Player('playerIframe', {
    playerVars: {
    playsinline: 1,      // iOSã§ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³å†ç”Ÿ
    rel: 0,              // çµ‚äº†å¾Œã®é–¢é€£å‹•ç”»ã‚’æŠ‘åˆ¶
    modestbranding: 1    // YouTubeãƒ­ã‚´æ§ãˆã‚
  },
    events: {
      onStateChange: (e) => {
        // å†ç”Ÿçµ‚äº†
        if (e.data === YT.PlayerState.ENDED && isAutoNextEnabled()) {
          playAdjacentVideo(1);
        }
      }
    }
  });
}

    
fetch(sheetJsonUrl)
  .then(r => r.json())
  .then(data => {
    allVideos = Array.isArray(data) ? data : [];
    initFilterBar();
    applyFilters();
    requestAnimationFrame(adjustFixedPlayerBottom);
  })
  .catch(err => {
    console.error('ã‚·ãƒ¼ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', err);
    const count = document.getElementById('songCount');
    if (count) count.textContent = 'ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸâ€¦';
  });

  const randomPlayButton = document.getElementById('randomPlayButton');
    randomPlayButton.addEventListener('click', () => {
  const list = currentFilteredVideos?.length ? currentFilteredVideos : allVideos;
  const randomVideo = list[Math.floor(Math.random() * list.length)];
    loadVideo(randomVideo, null);
});

    // é€£ç¶šå†ç”Ÿãƒˆã‚°ãƒ«ã®åˆæœŸåŒ–
const autoNextToggle = document.getElementById('autoNextToggle');
if (autoNextToggle) {
  autoNextToggle.checked = isAutoNextEnabled();
  autoNextToggle.addEventListener('change', (e) => {
    setAutoNextEnabled(e.target.checked);
  });
}

    // === å›ºå®šãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ NowPlaying ã®é‡ãªã‚Šå¯¾ç­– ===
function adjustFixedPlayerBottom() {
  const nowPlayingWrapperEl = document.getElementById('nowPlayingWrapper');
  if (!fixedPlayerEl || !nowPlayingWrapperEl || !playerIframe) return; 

  const h = nowPlayingWrapperEl.offsetHeight || 0;
  fixedPlayerEl.style.bottom = `${h + 8}px`;
  const total = (fixedPlayerEl.offsetHeight || 0) + h + 12;
  document.body.style.paddingBottom = `${total}px`;

  const maxH = getMaxPlayerHeight();
  const current = parseInt(playerIframe.style.height || 0, 10) ||
                  playerIframe.getBoundingClientRect().height;
  if (current > maxH) setPlayerHeight(maxH);
}

window.addEventListener('resize', () => {
  requestAnimationFrame(adjustFixedPlayerBottom);
});
window.addEventListener('orientationchange', () => {
  setTimeout(adjustFixedPlayerBottom, 50);
});
window.visualViewport?.addEventListener('resize', adjustFixedPlayerBottom);


// === ãƒªã‚µã‚¤ã‚ºï¼ˆé«˜ã•å¯å¤‰ï¼‰é–¢é€£ ===

const PLAYER_HEIGHT_KEY = 'playerHeightPx';
const MIN_PLAYER_H = 240;

function applyStoredPlayerHeight() {
  const stored = parseInt(localStorage.getItem(PLAYER_HEIGHT_KEY) || '', 10);
  if (!isNaN(stored)) {
    const maxH = getMaxPlayerHeight();
    const clamped = Math.max(MIN_PLAYER_H, Math.min(stored, maxH));
    playerIframe.classList.remove('aspect-video');
    playerIframe.style.height = clamped + 'px';
    if (playerFrameWrapper) playerFrameWrapper.style.height = clamped + 'px';
  }
  adjustFixedPlayerBottom();
}

// ç”»é¢ã‹ã‚‰ã¯ã¿å‡ºã•ãªã„æœ€å¤§é«˜ã•ã‚’è¨ˆç®—ï¼ˆãƒãƒ³ãƒ‰ãƒ«ãŒè¦‹ãˆã‚‹ã‚ˆã†ã«ä¸Šéƒ¨ã«ä½™ç™½ã‚’ç¢ºä¿ï¼‰
function getMaxPlayerHeight() {
  const vh = window.innerHeight;

  // fixedPlayer ã® bottom ã¯ NowPlaying é«˜ã• + 8px
  const nowH = document.getElementById('nowPlayingWrapper')?.offsetHeight || 0;
  const bottomOffset = nowH + 8;

  // å†…å´ã® p-4ï¼ˆä¸Šä¸‹16pxãšã¤ï¼‰ï¼åˆè¨ˆ32pxï¼ˆTailwindï¼‰
  const fixedPlayerVerticalPadding = 16 * 2;

  // ãƒãƒ³ãƒ‰ãƒ«åˆ†ã®å‡ºã£å¼µã‚Š + ä½™ç™½ï¼ˆè¦‹ã‚„ã™ã•ã®ãŸã‚ã«å°‘ã—å¤šã‚ï¼‰
  const handleAndTopSafety = 24 + 16; // ã ã„ãŸã„ 40px

  // ç”»é¢é«˜ã•ã‹ã‚‰ä¸‹ãƒãƒ¼ã‚¸ãƒ³ãƒ»ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ãƒ»ä¸Šã®å®‰å…¨ä½™ç™½ã‚’å¼•ã„ãŸå€¤ãŒä¸Šé™
  const maxH = vh - (bottomOffset + fixedPlayerVerticalPadding + handleAndTopSafety);

  // æœ€ä½ã§ã‚‚ MIN_PLAYER_H ä»¥ä¸Šã€ã‹ã¤è² ã«ãªã‚‰ãªã„ã‚ˆã†ã«
  return Math.max(MIN_PLAYER_H, Math.floor(maxH));
}


function setPlayerHeight(px) {
  const maxH = getMaxPlayerHeight();        // â† ç”»é¢ã‹ã‚‰ã¯ã¿å‡ºã•ãªã„ä¸Šé™
  const h = Math.max(MIN_PLAYER_H, Math.min(Math.round(px), maxH));

  playerIframe.classList.remove('aspect-video');
  playerIframe.style.height = h + 'px';
  if (playerFrameWrapper) playerFrameWrapper.style.height = h + 'px';
  localStorage.setItem(PLAYER_HEIGHT_KEY, String(h));
  adjustFixedPlayerBottom();
}


(function enablePlayerResize() {
  if (!resizeHandle || !playerIframe) return;

  let dragging = false, startY = 0, startH = 0;
  let prevUserSelect = '', prevCursor = '', prevOverflow = '';
  const preventScroll = (e) => e.preventDefault();

  const lockScroll = () => {
    // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æŠ‘æ­¢ï¼ˆiOSå«ã‚€ï¼‰
    prevOverflow = document.body.style.overflow;
    document.body.style.overflow = 'hidden';
    // ã‚¿ãƒƒãƒã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’å®Œå…¨åœæ­¢
    document.addEventListener('touchmove', preventScroll, { passive: false });
  };

  const unlockScroll = () => {
    document.body.style.overflow = prevOverflow;
    document.removeEventListener('touchmove', preventScroll, { passive: false });
  };

  const start = (y) => {
    dragging = true;
    startY = y;
    startH = parseInt(playerIframe.style.height || 0, 10) ||
             playerIframe.getBoundingClientRect().height;
    prevUserSelect = document.body.style.userSelect;
    prevCursor = document.body.style.cursor;
    document.body.style.userSelect = 'none';
    document.body.style.cursor = 'ns-resize';
    lockScroll();
  };

  const move = (y) => {
    if (!dragging) return;
    const dy = y - startY;
    setPlayerHeight(startH - dy); // ä¸Šã«å‹•ã‹ã™ã¨é«˜ã•ãŒå¢—ãˆã‚‹
  };

  const end = () => {
    if (!dragging) return;
    dragging = false;
    document.body.style.userSelect = prevUserSelect;
    document.body.style.cursor = prevCursor;
    unlockScroll();
  };

  // ãƒã‚¦ã‚¹
  resizeHandle.addEventListener('mousedown', (e) => {
    if (e.button !== 0) return;
    start(e.clientY);
  });
  window.addEventListener('mousemove', (e) => move(e.clientY));
  window.addEventListener('mouseup', end);

  // ã‚¿ãƒƒãƒï¼ˆpassive: false ã§ preventDefault ã‚’æœ‰åŠ¹ã«ï¼‰
  resizeHandle.addEventListener('touchstart', (e) => {
    start(e.touches[0].clientY);
  }, { passive: false });

  window.addEventListener('touchmove', (e) => {
    move(e.touches[0].clientY);
  }, { passive: false });

  window.addEventListener('touchend', end);
})();
    
function renderVideoList(videos) {
  videoList.innerHTML = '';

    // ä»¶æ•°è¡¨ç¤ºã‚’æ›´æ–°
  const countElement = document.getElementById('songCount');
  countElement.textContent = `${allVideos.length}æ›²ä¸­ ${videos.length}æ›²è¡¨ç¤ºä¸­`;

  let playingElement = null;

  videos.forEach(video => {
    const item = document.createElement('div');
    item.className = 'p-3 mb-3 bg-blue-100 rounded-lg shadow-md border-2 border-teal-700 space-y-1';

    const key = `${video["videoId"]}__${parseInt(video["start"] || 0)}`;
    if (key === nowPlayingKey) {
      item.classList.add('playing');
      playingElement = item;
    }

    
    // 1è¡Œç›®ï¼šã‚¿ã‚¤ãƒˆãƒ« / ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ
    const topRow = document.createElement('div');
    topRow.className = 'video-item-row';

    const title = document.createElement('a');
    title.href = "#";
    title.className = 'video-title hover:underline';
    title.textContent = video["title"];
    title.onclick = e => {
      e.preventDefault();
      loadVideo(video, item);
    };

    const slash = document.createElement('span');
    slash.textContent = ' / ';

    const artist = document.createElement('span');
    artist.className = 'video-artist';
    artist.textContent = video["artist"];

    topRow.appendChild(title);
    topRow.appendChild(slash);
    topRow.appendChild(artist);

    // 2è¡Œç›®ï¼šè©³ç´°æƒ…å ±
    const metaRow = document.createElement('div');
    metaRow.className = 'video-meta';
   [
  video["ã‚«ãƒ†ã‚´ãƒª"],
  video["å…¬é–‹æœˆ"],
  video["å‹•ç”»ç¨®åˆ¥"],
  video["æ‹…å½“åŒºåˆ†"],
  video["platform"] // â† ã“ã“ã« undefined ãŒã‚ã‚‹ã¨å…¨éƒ¨æ­¢ã¾ã‚‹
].filter(Boolean).forEach(text => {
  const span = document.createElement('span');
  span.textContent = text;
  metaRow.appendChild(span);
});


    item.appendChild(topRow);
    item.appendChild(metaRow);
    videoList.appendChild(item);
  });
  // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å®Ÿè¡Œ
  if (playingElement) {
    playingElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }
}

    
function loadVideo(video, item) {
  const start = parseInt(video["start"] || '0', 10);
  let videoId = video["videoId"];
  let platform = (video["platform"] || "").toLowerCase();

  if (!videoId) {
    alert("videoId ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“");
    return;
  }
  if (!platform) {
    alert("platform ãŒæœªæŒ‡å®šã®ãŸã‚å†ç”Ÿã§ãã¾ã›ã‚“");
    return;
  }

  if (platform.includes("youtube")) {
    const match = videoId.match(/(?:v=|\/|youtu\.be\/)?([0-9A-Za-z_-]{11})/);
    if (match) videoId = match[1];

    // IFrame API å„ªå…ˆ
    if (ytApiReady) {
      tryInitYtPlayer(); // æœªåˆæœŸåŒ–ãªã‚‰åˆæœŸåŒ–
      if (ytPlayer && typeof ytPlayer.loadVideoById === 'function') {
        const wasHidden = fixedPlayerEl.style.display === 'none';
        fixedPlayerEl.style.display = 'block';
        ytPlayer.loadVideoById({ videoId, startSeconds: start });
        if (wasHidden) applyStoredPlayerHeight();
      } else {
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šç›´URL
        playerIframe.src =
          `https://www.youtube.com/embed/${videoId}?start=${start}&autoplay=1&enablejsapi=1&playsinline=1`;
        fixedPlayerEl.style.display = 'block';
        applyStoredPlayerHeight();
      }
    } else {
      // APIæœªæº–å‚™ï¼šç›´URL
      playerIframe.src =
        `https://www.youtube.com/embed/${videoId}?start=${start}&autoplay=1&enablejsapi=1&playsinline=1`;
      fixedPlayerEl.style.display = 'block';
      applyStoredPlayerHeight();
    }

  } else if (platform === "tiktok") {
    // TikTok ã¯å¾“æ¥ã©ãŠã‚Š src ã‚’å·®ã—æ›¿ãˆ
    const match = videoId.match(/video\/(\d+)/);
    const tiktokId = match ? match[1] : videoId;
    playerIframe.src = `https://www.tiktok.com/embed/v2/${tiktokId}`;
    fixedPlayerEl.style.display = 'block';
    applyStoredPlayerHeight();

  } else {
    alert(`æœªå¯¾å¿œã® platform: ${platform}`);
    return;
  }

  // å†ç”Ÿä¸­ã®æ›²åãƒ»ãƒã‚¤ãƒ©ã‚¤ãƒˆæ›´æ–°
  const nowPlayingTitle = document.getElementById('nowPlayingTitle');
  nowPlayingTitle.textContent = `${video["title"]} - ${video["artist"]}`;
  nowPlayingKey = `${video["videoId"]}__${start}`;
  applyFilters(); // ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼†ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«åæ˜ 
}

if (closeBtn) {
  closeBtn.addEventListener('click', () => {
    document.body.style.paddingBottom =
      `${(document.getElementById('nowPlayingWrapper')?.offsetHeight || 0) + 12}px`;

    if (ytPlayer && typeof ytPlayer.stopVideo === 'function') {
      ytPlayer.stopVideo();
    } else if (playerIframe?.src.includes("youtube.com")) {
      playerIframe.contentWindow?.postMessage(JSON.stringify({
        event: 'command',
        func: 'pauseVideo',
        args: []
      }), '*');
    } else {
      playerIframe.src = "";
    }
    fixedPlayerEl.style.display = 'none';
  });
}




  // å¤ã„åŸ‹ã‚è¾¼ã¿ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å‰Šé™¤ï¼ˆå›ºå®šãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ä½¿ã†ã®ã§ä»–ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯å‰Šé™¤ï¼‰
  document.querySelectorAll('.video-player-container').forEach(el => el.remove());

  document.getElementById('prevVideoBtn').addEventListener('click', () => {
  playAdjacentVideo(-1);
  });

  document.getElementById('nextVideoBtn').addEventListener('click', () => {
  playAdjacentVideo(1);
  });

    document.getElementById('randomFromFilteredBtn').addEventListener('click', () => {
  const list = currentFilteredVideos?.length ? currentFilteredVideos : allVideos;
  const randomVideo = list[Math.floor(Math.random() * list.length)];
  loadVideo(randomVideo, null);
});

function playAdjacentVideo(direction) {
  if (!currentFilteredVideos.length) return;

  const currentIndex = currentFilteredVideos.findIndex(v =>
    `${v.videoId}__${v.start || 0}` === nowPlayingKey
    );

  const newIndex = currentIndex + direction;
  if (newIndex >= 0 && newIndex < currentFilteredVideos.length) {
    loadVideo(currentFilteredVideos[newIndex], null);
    }
    }

// ====== ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¨­å®šï¼ˆã‚·ãƒ¼ãƒˆã®ãƒ˜ãƒƒãƒ€ãƒ¼åã«å¯¾å¿œï¼‰ ======
const KEY = {
  category: "ã‚«ãƒ†ã‚´ãƒª",
  month: "å…¬é–‹æœˆ",        // ä¾‹: "2025-08" ãªã©
  videoType: "å‹•ç”»ç¨®åˆ¥",
  role: "æ‹…å½“åŒºåˆ†",
};

// "2025-08" / "2025/08" / "2025-08-21" â†’ "2025/08"
function monthYM(v){
  if(!v) return "";
  const s = String(v).slice(0,7).replace('-', '/');
  return /^\d{4}\/\d{2}$/.test(s) ? s : "";
}

// é‡è¤‡ãªã—é…åˆ—
function uniqueValues(arr, getter){
  const s = new Set();
  arr.forEach(it => s.add(getter(it) || ""));
  s.delete("");
  return [...s];
}

// ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ç¾¤ã‚’æç”»
function renderCheckboxes(groupKey, values, container){
  container.innerHTML = values.map(val => {
    const id = `${groupKey}-${val}`.replace(/\W+/g, "_");
    return `
      <label for="${id}" class="flex items-center gap-2 text-sm">
        <input id="${id}" type="checkbox" value="${val}" data-group="${groupKey}" class="accent-black">
        <span>${val}</span>
      </label>
    `;
  }).join("");
}

// é¸æŠå€¤å–å¾—
function getSelected(groupKey){
  return [...document.querySelectorAll(`input[type="checkbox"][data-group="${groupKey}"]:checked`)]
    .map(cb => cb.value);
}

// æ¤œç´¢å¯¾è±¡ã‚­ãƒ¼
const SEARCH_KEYS = ["title", "artist"];

// ãƒ†ã‚­ã‚¹ãƒˆä¸€è‡´
function matchText(it, q){
  if(!q) return true;
  const needle = q.trim().toLowerCase();
  if(!needle) return true;
  return SEARCH_KEYS.some(k => String(it[k] ?? "").toLowerCase().includes(needle));
}

// ä¸¦ã³æ›¿ãˆ
function sortList(list, order){
  const copy = [...list];
  const coll = new Intl.Collator('ja');
  if (order === "asc" || order === "desc") {
    copy.sort((a, b) => {
      const aD = Date.parse((a[KEY.month] ? String(a[KEY.month]).slice(0,7).replace('/', '-') : "") + "-01") || 0;
      const bD = Date.parse((b[KEY.month] ? String(b[KEY.month]).slice(0,7).replace('/', '-') : "") + "-01") || 0;
      return order === "asc" ? aD - bD : bD - aD;
    });
  } else if (order === "title") {
    copy.sort((a,b) => coll.compare(String(a.title || ""), String(b.title || "")));
  } else if (order === "artist") {
    copy.sort((a,b) => coll.compare(String(a.artist || ""), String(b.artist || "")));
  }
  return copy;
}

// æç”»ï¼ˆæ—¢å­˜ã®ãƒ¬ãƒ³ãƒ€ãƒ©ã¸æ©‹æ¸¡ã—ï¼‰
function render(list){
  renderVideoList(list);
  currentFilteredVideos = list;
  const countElement = document.getElementById('songCount');
  if (countElement) countElement.textContent = `${allVideos.length}æ›²ä¸­ ${list.length}æ›²è¡¨ç¤ºä¸­`;
}

// ãƒ•ã‚£ãƒ«ã‚¿æœ¬ä½“ï¼šãƒã‚§ãƒƒã‚¯ â†’ æ¤œç´¢ â†’ ã‚½ãƒ¼ãƒˆ â†’ render
function applyFilters(){
  const selected = {
    category: getSelected("category"),
    month:    getSelected("month"),
    videoType:getSelected("videoType"),
    role:     getSelected("role"),
  };
  const q = document.getElementById('searchInput')?.value || "";
  const order = document.getElementById('sortOrder')?.value || "desc";

  // 1) ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹
  let filtered = allVideos.filter(it => {
    const ym = monthYM(it[KEY.month]); // "YYYY/MM"
    const c1 = !selected.category.length || selected.category.includes(it[KEY.category]);
    const c2 = !selected.month.length    || selected.month.includes(ym);
    const c3 = !selected.videoType.length|| selected.videoType.includes(it[KEY.videoType]);
    const c4 = !selected.role.length     || selected.role.includes(it[KEY.role]);
    return c1 && c2 && c3 && c4;
  });

  // 2) æ¤œç´¢
  filtered = filtered.filter(it => matchText(it, q));

  // 3) ã‚½ãƒ¼ãƒˆ
  filtered = sortList(filtered, order);

  // 4) æç”»
  render(filtered);
}

// åˆæœŸåŒ–ï¼šãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ç”Ÿæˆï¼‹ã‚¤ãƒ™ãƒ³ãƒˆæ¥ç¶š
function initFilterBar(){
  // å€¤ä¸€è¦§ã‚’ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰è‡ªå‹•æŠ½å‡º
  const cats  = uniqueValues(allVideos, it => it[KEY.category]).sort();
  const mons  = uniqueValues(allVideos, it => monthYM(it[KEY.month])).sort().reverse();
  const vts   = uniqueValues(allVideos, it => it[KEY.videoType]).sort();
  const roles = uniqueValues(allVideos, it => it[KEY.role]).sort();

  renderCheckboxes("category", cats,  document.querySelector('[data-group="category"]'));
  renderCheckboxes("month",    mons,  document.querySelector('[data-group="month"]'));
  renderCheckboxes("videoType",vts,   document.querySelector('[data-group="videoType"]'));
  renderCheckboxes("role",     roles, document.querySelector('[data-group="role"]'));

  // å³æ™‚åæ˜ 
  document.querySelectorAll('#filters input[type="checkbox"]').forEach(cb => {
    cb.addEventListener('change', applyFilters);
  });

  // æ¤œç´¢ãƒ»ã‚½ãƒ¼ãƒˆ
  document.getElementById('searchInput')?.addEventListener('input', applyFilters);
  document.getElementById('sortOrder')?.addEventListener('change', applyFilters);

  // ãƒªã‚»ãƒƒãƒˆ
  document.getElementById('resetFilters')?.addEventListener('click', () => {
    document.querySelectorAll('#filters input[type="checkbox"]').forEach(cb => cb.checked = false);
    const s = document.getElementById('searchInput'); if (s) s.value = "";
    const so = document.getElementById('sortOrder');  if (so) so.value = "desc";
    applyFilters();
  });
    setupDropdowns(document.getElementById('filters'));
}

    function setupDropdowns(root = document) {
  const all = [...root.querySelectorAll('.filter-dropdown')];

  const closeAll = () => {
    all.forEach(drop => {
      const btn = drop.querySelector('.filter-toggle');
      const menu = drop.querySelector('.filter-menu');
      const chev = btn?.querySelector('.chevron');
      btn?.setAttribute('aria-expanded', 'false');
      menu?.classList.add('hidden');
      chev?.classList.remove('rotate-180');
    });
  };

  all.forEach(drop => {
    const btn = drop.querySelector('.filter-toggle');
    const menu = drop.querySelector('.filter-menu');
    const chev = btn.querySelector('.chevron');

    const open = () => {
      btn.setAttribute('aria-expanded','true');
      menu.classList.remove('hidden');
      chev.classList.add('rotate-180');
    };
    const close = () => {
      btn.setAttribute('aria-expanded','false');
      menu.classList.add('hidden');
      chev.classList.remove('rotate-180');
    };

    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const expanded = btn.getAttribute('aria-expanded') === 'true';
      closeAll();
      expanded ? close() : open();
    });

    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼å†…ã‚¯ãƒªãƒƒã‚¯ã¯é–‰ã˜ãªã„ï¼ˆãƒã‚§ãƒƒã‚¯æ“ä½œã‚’é‚ªé­”ã—ãªã„ï¼‰
    menu.addEventListener('click', (e) => e.stopPropagation());
  });

  // å¤–å´ã‚¯ãƒªãƒƒã‚¯ã§å…¨éƒ¨é–‰ã˜ã‚‹
  document.addEventListener('click', closeAll);
}




  </script>
</body>
</html>
